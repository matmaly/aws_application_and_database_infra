{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation RDS multi AZ instance",

    "Parameters": {
        "ALBSecurityGroupID" : {
            "Type" : "String",
            "Description": "ALB SG group ID from the Network layer"
        },
        "ProdAppSecurityGroupID" : {
            "Type" : "String",
            "Description": "App SG group ID from the Network layer"
        },
        "PublicSubnet1ID" : {
            "Type" : "String",
            "Description": "Public Subnet 1 ID"
        },
        "PublicSubnet2ID" : {
            "Type" : "String",
            "Description": "Public Subnet 2 ID"
        },
        "PrivateSubnet1ID" : {
            "Type" : "String",
            "Description": "Private Subnet 1 ID"
        },
        "PrivateSubnet2ID" : {
            "Type" : "String",
            "Description": "Private Subnet 2 ID"
        }
    }
       
    },
    "Resources": {
        "ProdApplicationServersLaunchTemplate": {
            "Type" : "AWS::EC2::LaunchTemplate",
            "Properties" : {
                "LaunchTemplateName" : "ProdApplicationServersLaunchTemplate",
                "LaunchTemplateData" : {
                    "BlockDeviceMapping" : {
                        "Ebs" : {
                          "VolumeType" : "gp2",
                          "DeleteOnTermination" : "true",
                          "VolumeSize" : "20",
                          "Encrypted" : "true"
                        }
                    },
                    "ImageId" : "ami-0d5eff06f840b45e9",
                    "InstanceType" : "t2.small",
                    "KeyName" : "vockey",
                    "SecurityGroupIds" : [ "!Ref" : "AppSecurityGroupID" ],
                    "UserData" : {
                        "Fn::Base64" : { "Fn::Join" : ["",[
        			        "#!/bin/bash -ex","\n",
        			        "yum -y update","\n",
                            "amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2","\n",
                            "yum install -y httpd mariadb-server","\n",
                            "chkconfig httpd on","\n",
                            "service httpd start","\n",
                            "cd /home/ec2-user","\n",
                            "wget https://aws-tc-largeobjects.s3-us-west-2.amazonaws.com/ILT-TF-200-ACACAD-20-EN/capstone-project/Countrydatadump.sql","\n",
                            "chown ec2-user:ec2-user Countrydatadump.sql","\n",
                            "cd /var/www/html","\n",
                            "wget https://aws-tc-largeobjects.s3-us-west-2.amazonaws.com/ILT-TF-200-ACACAD-20-EN/capstone-project/Example.zip","\n",
                            "unzip Example.zip -d /var/www/html/","\n",]]}
                    }
                }
            }
        },
        "ProdAppASG" : {
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "Properties" : {
                "AutoScalingGroupName" : "ProductionServersAutoScalingGroup",
                "CapacityRebalance" : "true",
                "DesiredCapacity" : "2",
                "HealthCheckGracePeriod" : 300,
                "HealthCheckType" : "ELB",
                "LaunchTemplate" : {
                    "LaunchTemplateId" : { "!Ref" : "ProdApplicationServersLaunchTemplate" },
                    "Version" : {
                        "Fn::GetAtt" : ["ProdApplicationServersLaunchTemplate", "LatestVersionNumber"]
                    }
                },
                "MaxSize" : "4",
                "MinSize" : "2",
                "ServiceLinkedRoleARN" : String,
                "Tags" : [ TagProperty, ... ],
                "TargetGroupARNs" : [ String, ... ],
                "TerminationPolicies" : [ String, ... ],
                "VPCZoneIdentifier" : [{ "!Ref" : "PrivateSubnet1ID" }, { "!Ref" : "PrivateSubnet2ID" }]
            }
        },
        "ProdApplicationInstance" : {
            "Type" : "AWS::EC2::Instance",
            "Properties" : {
                "ImageId" : "ami-0d5eff06f840b45e9",
                "KeyName" : "vockey",
                "InstanceType" : "t2.small",
                
                "BlockDeviceMappings" : [
                    {
                        "DeviceName" : "/dev/sdm",
                        "Ebs" : {
                        "VolumeType" : "io1",
                        "Iops" : "200",
                        "DeleteOnTermination" : "false",
                        "VolumeSize" : "20"
                        }
                    }, 
                    {
                        "DeviceName" : "/dev/sdk",
                        "NoDevice" : {}
                    }
                ]
            }
        }
        "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties" : {
            "IpAddressType" : "ipv4",
            "Name" : "ProdApplicationLoadBalancer",
            "Scheme" : "internet-facing",
            "SecurityGroups" : [{ "!Ref" : "ALBSecurityGroupID" }],
            "Subnets" : [{ "!Ref" : "PublicSubnet1ID" }, { "!Ref" : "PublicSubnet2ID" }],
            "Tags" : [ { "Key" : "Name", "Value" : "Prod DB SG" }, { "Key" : "stack", "Value" : "production" }, { "Key" : "stackType", "Value" : "compute" } ],
            "Type" : "application"
        }
    }
}
